<!DOCTYPE html><html><head><meta charset="utf-8" /><!--Always force latest IE rendering engine or request Chrome Frame--><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><!--Use title if it's in the page YAML frontmatter--><meta content="width=device-width, initial-scale=1.0;" name="viewport" /><title>Performance Gains In 4.0</title><link href="/stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/all.css" rel="stylesheet" type="text/css" /><link href="favicon.png" rel="icon" type="image/png" /></head><body class="page_classes blog blog_2014 blog_2014_12 blog_2014_12_26 blog_2014_12_26_performance_gains_in_4-0"><header class="navbar navbar-static-top"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" data-target=".bs-navbar-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><img src="/images/logo.png" /></a></div><nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation"><ul class="nav navbar-nav"><li><a href="../../../../#latest-news">News</a></li><li><a href="https://github.com/neo4jrb/neo4j/wiki">Documentation</a></li><li><a href="../../../../#getting-started">Get started</a></li><li><a href="../../../../#getting-involved">Get involved</a></li><li><a href="../../../../#getting-help">Help</a></li></ul></nav></div></header><div class="container" id="main"><div class="row"><div class="col-xs-8" id="content"><div class="panel blog-post"><div class="panel-heading"><h2>Performance Gains In 4.0</h2></div><div class="panel-body"><p>Over the past few days, I&#39;ve been seeking and destroying some bugs that are usually simple to correct: gem-created Cypher queries that don&#39;t use params and n + x calls to the database. You can see all of the pull requests so far <a href="https://github.com/neo4jrb/neo4j-core/pull/146/files">here</a>, <a href="https://github.com/neo4jrb/neo4j-core/pull/147/files">here</a>, and <a href="https://github.com/neo4jrb/neo4j/pull/651/files">here</a>, but there may be one more coming. I expected a slight performance improvement but after running benchmarks, what I found was quite a bit more impressive.</p>

<p>I use <a href="https://github.com/evanphx/benchmark-ips"><code>Benchmark.ips</code></a>, which runs given commands as many times as it can over a set period of time, then reports the average number of iterations per second and total completions. I have a simple series of queries that I use to get some baseline performance stats: create two nodes, create a relationship, return the relationship, delete the nodes. Once without a transaction, once within a transaction, and this time I added transaction + ActiveRel. All specs are run on my MacBook Pro (SSD) using Ruby 2.2.0 and Neo4j 2.2.0 M02 with completely stock settings. I found the 2-second warmup in the tests to be insufficient to let caches warm up, so these are after a few minutes of running the tests.</p>

<pre><code>require &#39;benchmark/ips&#39;
Student.delete_all; Lesson.delete_all
Benchmark.ips do |x|
  x.config(warmup: 2, time: 60)

  x.report(&#39;create, create, rel, destroy&#39;) do
    s = Student.create(name: &#39;Lauren&#39;); l = Lesson.create(subject: &#39;Math&#39;); s.lessons &lt;&lt; l; s.lessons.first; s.destroy; l.destroy
  end

  x.report(&#39;transaction create, create, rel, destroy&#39;) do
    begin
      tx = Neo4j::Transaction.new
      s = Student.create(name: &#39;Lauren&#39;); l = Lesson.create(subject: &#39;Math&#39;); s.lessons &lt;&lt; l; s.lessons.first; s.destroy; l.destroy
    ensure
      tx.close
    end
  end

  x.report(&#39;transaction create with activerel&#39;) do
    begin
      tx = Neo4j::Transaction.new
      s = Student.create(name: &#39;Lauren&#39;); l = Lesson.create(subject: &#39;Math&#39;); EnrolledIn.create(from_node: s, to_node: l); s.lessons.first; s.destroy; l.destroy
    ensure
      tx.close
    end
  end

  x.compare!
end
</code></pre>

<p>Before (Neo4j.rb 4.0.0.rc.3 and Neo4j-core 3.1.0):</p>

<ul>
<li>transaction create with activerel:       25.0 i/s</li>
<li>transaction create, create, rel, destroy:       20.7 i/s - 1.21x slower</li>
<li>create, create, rel, destroy:       18.3 i/s - 1.36x slower</li>
</ul>

<p>After (master branches on December 26, 2014):</p>

<ul>
<li>transaction create, create, rel, destroy:       59.9 i/s</li>
<li>transaction create with activerel:       58.4 i/s - 1.03x slower</li>
<li>create, create, rel, destroy:       30.1 i/s - 1.99x slower</li>
</ul>

<p>I ran another test, a basic create node/destroy node test both with and without a transaction. There are two transaction tests because one used <code>Neo4j::Transaction.run</code> with a block, the other used <code>Neo4j::Transaction.new</code>.</p>

<p>Before:</p>

<ul>
<li>destroy without transaction:       64.3 i/s</li>
<li>destroy with transaction - run:       58.6 i/s - 1.10x slower</li>
<li>destroy with transaction - new:       58.4 i/s - 1.10x slower</li>
</ul>

<p>After:</p>

<ul>
<li>destroy without transaction:      150.0 i/s</li>
<li>destroy with transaction - new:      130.9 i/s - 1.15x slower</li>
<li>destroy with transaction - run:      127.8 i/s - 1.17x slower</li>
</ul>

<p>That&#39;s a huge difference from really basic refactoring. Everyone should benefit from this, so I&#39;m pretty happy about it. It also reaffirms that even if you aren&#39;t adding new features, you can always help an open source project by refactoring existing code. We always welcome pull requests, so if you ever have some time and want to get involved, benchmarks and improvements are always a great way to get involved.</p>
</div><small>Posted 2014/12/26 by Chris Grigg<br />Tagged with <a href="/blog/tags/benchmarks.html">benchmarks</a>, <a href="/blog/tags/news.html">news</a>, <a href="/blog/tags/milestones.html">milestones</a></small></div></div><div class="col-sm-1"></div><div class="col-sm-3" id="sidebar"><div class="panel"><div class="panel-body"><p class="git-stats build-info"></p><p class="latest-release build-info"></p><p class="git-star build-info"><iframe allowtransparency="true" frameborder="0" height="20" scrolling="0" src="http://ghbtns.com/github-btn.html?user=neo4jrb&repo=neo4j&type=watch&count=true&size=small" width="110"></iframe></p><p><a href="https://travis-ci.org/neo4jrb/neo4j"><img src="https://travis-ci.org/neo4jrb/neo4j.svg?branch=master" /></a></p><p><a href="https://coveralls.io/r/neo4jrb/neo4j?branch=master"><img src="https://coveralls.io/repos/neo4jrb/neo4j/badge.png?branch=master" /></a></p><a href="https://codeclimate.com/github/neo4jrb/neo4j"><img src="https://codeclimate.com/github/neo4jrb/neo4j/badges/gpa.svg" /></a></div></div><div class="panel"><div class="panel-header"><h3>Primary maintainers</h3></div><div class="panel-body"><div class="maintainer"><h4>Chris Grigg</h4><div class="media"><div class="media-left"><img src="https://avatars.githubusercontent.com/subvertallchris" /></div><div class="media-body"><div><i class="fa fa-external-link"></i> <a href="http://blog.subvertallmedia.com/">Blog</a></div><div><i class="fa fa-github"></i> <a href="https://github.com/subvertallchris/">subvertallchris</a></div><div><i class="fa fa-twitter"></i> <a href="https://twitter.com/subvertallmedia">subvertallmedia</a></div></div></div></div><div class="maintainer"><h4>Brian Underwood</h4><div class="media"><div class="media-left"><img src="https://avatars.githubusercontent.com/cheerfulstoic" /></div><div class="media-body"><div><i class="fa fa-external-link"></i> <a href="http://blog.brian-underwood.codes/">Blog</a></div><div><i class="fa fa-github"></i> <a href="https://github.com/cheerfulstoic/">cheerfulstoic</a></div><div><i class="fa fa-twitter"></i> <a href="https://twitter.com/cheerfulstoic">cheerfulstoic</a></div></div></div></div></div><div class="panel-header"><h3>Original Creator</h3></div><div class="panel-body"><div class="maintainer"><h4>Andreas Ronge</h4><div class="media"><div class="media-left"><img src="https://avatars.githubusercontent.com/andreasronge" /></div><div class="media-body"><div><i class="fa fa-external-link"></i> <a href="http://www.jayway.com/author/andreasronge/">Blog</a></div><div><i class="fa fa-github"></i> <a href="https://github.com/andreasronge">andreasronge</a></div><div><i class="fa fa-twitter"></i> <a href="https://twitter.com/ronge">ronge</a></div></div></div></div></div></div><div class="panel"><div class="panel-body"><script data-gratipay-username="cheerfulstoic" src="//grtp.co/v1.js"></script></div></div></div></div></div><a href="https://github.com/neo4jrb/neo4j" id="github"><img alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" style="position: absolute; top: 0; right: 0; border: 0;" /></a><script src="/javascripts/all.js" type="text/javascript"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-57970757-1', 'auto');
ga('send', 'pageview');</script></body></html>