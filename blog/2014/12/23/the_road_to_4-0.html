<!DOCTYPE html><html><head><meta charset="utf-8" /><!--Always force latest IE rendering engine or request Chrome Frame--><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><!--Use title if it's in the page YAML frontmatter--><meta content="width=device-width, initial-scale=1.0;" name="viewport" /><title>The Road To 4.0</title><link href="/stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/all.css" rel="stylesheet" type="text/css" /><script src="/javascripts/all.js" type="text/javascript"></script><link href="favicon.png" rel="icon" type="image/png" /><body class="page_classes blog blog_2014 blog_2014_12 blog_2014_12_23 blog_2014_12_23_the_road_to_4-0"><header class="navbar navbar-static-top"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" data-target=".bs-navbar-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><img src="/images/logo.png" /></a></div><nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation"><ul class="nav navbar-nav"><li><a href="../../../../#latest-news">News</a></li><li><a href="https://github.com/neo4jrb/neo4j/wiki">Documentation</a></li><li><a href="../../../../#getting-started">Get started</a></li><li><a href="../../../../#getting-involved">Get involved</a></li><li><a href="../../../../#getting-help">Help</a></li></ul></nav></div></header><div class="container" id="main"><div class="row"><div class="col-xs-8" id="content"><div class="panel blog-post"><div class="panel-heading"><h2>The Road To 4.0</h2></div><div class="panel-body"><p>When we released Neo4j.rb 3.0, it was the result of about a year&#39;s worth of work, a complete rebuild of both the Neo4j and Neo4j-core gems. We were proud of it, and reasonably so, since we reached all of our major goals: Ruby MRI support, node and relationship classes, more of an ActiveRecord feel, more powerful associations, and improved Cypher DSL, just to name the big ones. Sure, there was more to do, but a lot of progress had been made and Neo4j + Rails could be together at last!</p>

<p>Still, there was something that always bugged me: the <code>_classname</code> property.</p>

<h3>The Sordid History of <code>_classname</code></h3>

<p><code>_classname</code> first appeared in Neo4j.rb 2.0, which used Neo4j 1.9 in Embedded mode. In those dark days, there were no labels, so the only way of identifying the class of a node was through a property. Someone decided <code>_classname</code> as the one to use and that was that.</p>

<p>Fast-forward to the dev process for Neo4j.rb 3.0, which went all-in with Neo4j 2.0. Now that we had labels, we had an easy way to match a node to a class! Hoorah! Except... not. By default, returning a node from Cypher wouldn&#39;t give you its labels. <code>MATCH (n) WHERE ID(n) = {node_id} RETURN n</code> would give you the IDs, properties, and a whole lot of REST endpoints, but no labels. The solution? A second query to get the missing info, <code>MATCH (n) WHERE ID(n) = {node_id} RETURN LABELS(n)</code>. One extra query for every single node returned from the database. Not cool.</p>

<p>The solution, of course, was to go back to <code>_classname</code>. I implemented the code -- it was one of my first big contributions to the gem, if I remember correctly -- but nobody was really thrilled by the prospect. We try to avoid poluting the graph with metadata hidden from the user as much as possible, so it just felt sort of wrong; on top of that, it made interoperability with existing Neo4j databases require a potentially painful migration to add the missing property or be doomed to n + 1 Hell.</p>

<p>When it came to relationships, things were a little different: it returned the relationship <code>type</code>, which made it possible to map directly to models. I pushed to use <code>_classname</code> there in order to keep consistency throughout the graph and give extra flexibility, since requiring that relationship models match types can make for some awkward model names.</p>

<h3>Classname Warfare</h3>

<p>Shortly after we released the gem officially -- I&#39;m talking like two or three weeks, tops -- Neo Tech released Neo4j 2.1.5, which included a <code>metadata</code> key in its JSON response. This key contained the labels of each node, something we had requested when we were visiting them in Malm√∂. The gem had launched, it was too late to go back. Even if we had known, it probably wouldn&#39;t have changed anything, since it would only really benefit people using the bleeding edge release.</p>

<p>Still, we were excited about killing off <code>_classname</code> and put it at the top of our wishlist for 4.0. The changes are all merged into master and we should be able to do a final release shortly.</p>

<p>So... how does it work? It&#39;s not all that complicated. The tl;dr version is that it looks for a <code>_classname</code> property, uses it if it finds it, and falls back to relationship type or labels if not. If labels are missing -- say, you&#39;re using Neo4j 2.1.4 and for some reason disabled <code>_classname</code> or are using an existing database -- it performs an additional query to find the labels and load the node as expected. If for some reason you want to use <code>_classname</code>, you can use it; if you want an ActiveRel model that doesn&#39;t match the <code>type</code> value, you can do that; if you have an ActiveRel model named to match the intended <code>type</code>, you can skip the <code>type</code> method altogether! Cool stuff. We keep maintain a stable master branch and believe this to be safe to use now.</p>

<h3>But wait, there&#39;s more!</h3>

<p>The 4.0 version of the gem is full of new features. More than anything else, I&#39;m excited about Brian&#39;s updates to scopes: you&#39;re now able to call scopes and methods within QueryProxy chains.</p>

<pre><code class="ruby">def top_students
  all.students(:s, :r).where(gpa: 100)
end

def top_teachers
  all.top_students.teachers
end

# in your code, to return all of the top teachers for Math...
math.top_teachers.to_a
</code></pre>

<p>Cool.</p>

<p>I&#39;m also particularly stoked about <code>match_to</code>, <code>rels_to</code>, and the ability to use <code>OPTIONAL MATCH</code> and switch from <code>Neo4j::Core::Query</code> back to <code>Neo4j::ActiveNode::Query::Proxy</code> within one chain.</p>

<p>Sometime soon, we&#39;ll do a couple blog posts (or screencasts?) elaborating on some of these new features; in the meantime, the <a href="https://github.com/neo4jrb/neo4j/blob/master/CHANGELOG">changelog file</a> covers the basics and the <a href="https://github.com/neo4jrb/neo4j/wiki/Neo4j.rb-v4-Introduction">4.0 introduction</a> goes into some more depth. As always, we&#39;re always happy to receive pull requests, answer questions, or see/hear about what you&#39;re doing with the gem(s)!</p>
</div><small>Posted 2014/12/23 by Chris Grigg<br />Tagged with <a href="/blog/tags/releases.html">releases</a>, <a href="/blog/tags/blog.html">blog</a>, <a href="/blog/tags/history-lesson.html">history lesson</a></small></div></div><div class="col-sm-1"></div><div class="col-sm-3" id="sidebar"><div class="panel"><div class="panel-body"><p class="git-stats build-info"></p><p class="latest-release build-info"></p><p class="git-star build-info"><iframe allowtransparency="true" frameborder="0" height="20" scrolling="0" src="http://ghbtns.com/github-btn.html?user=neo4jrb&repo=neo4j&type=watch&count=true&size=small" width="110"></iframe></p><p><a href="https://travis-ci.org/neo4jrb/neo4j"><img src="https://travis-ci.org/neo4jrb/neo4j.svg?branch=master" /></a></p><p><a href="https://coveralls.io/r/neo4jrb/neo4j?branch=master"><img src="https://coveralls.io/repos/neo4jrb/neo4j/badge.png?branch=master" /></a></p><a href="https://codeclimate.com/github/neo4jrb/neo4j"><img src="https://codeclimate.com/github/neo4jrb/neo4j/badges/gpa.svg" /></a></div></div><div class="panel"><div class="panel-header"><h3>Primary maintainers</h3></div><div class="panel-body"><div class="maintainer"><h4>Chris Grigg</h4><div class="media"><div class="media-left"><img src="https://avatars.githubusercontent.com/subvertallchris" /></div><div class="media-body"><div><i class="fa fa-external-link"></i> <a href="http://blog.subvertallmedia.com/">Blog</a></div><div><i class="fa fa-github"></i> <a href="https://github.com/subvertallchris/">subvertallchris</a></div><div><i class="fa fa-twitter"></i> <a href="https://twitter.com/subvertallmedia">subvertallmedia</a></div></div></div></div><div class="maintainer"><h4>Brian Underwood</h4><div class="media"><div class="media-left"><img src="https://avatars.githubusercontent.com/cheerfulstoic" /></div><div class="media-body"><div><i class="fa fa-external-link"></i> <a href="http://blog.brian-underwood.codes/">Blog</a></div><div><i class="fa fa-github"></i> <a href="https://github.com/cheerfulstoic/">cheerfulstoic</a></div><div><i class="fa fa-twitter"></i> <a href="https://twitter.com/cheerfulstoic">cheerfulstoic</a></div></div></div></div></div></div><div class="panel"><div class="panel-body"><script data-gratipay-username="cheerfulstoic" src="//grtp.co/v1.js"></script></div></div></div></div></div></body><a href="https://github.com/neo4jrb/neo4j" id="github"><img alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" style="position: absolute; top: 0; right: 0; border: 0;" /></a></head></html>