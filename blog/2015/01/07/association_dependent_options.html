<!DOCTYPE html><html><head><meta charset="utf-8" /><!--Always force latest IE rendering engine or request Chrome Frame--><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><!--Use title if it's in the page YAML frontmatter--><meta content="width=device-width, initial-scale=1.0;" name="viewport" /><title>Association Dependent Options</title><link href="/stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="/stylesheets/all.css" rel="stylesheet" type="text/css" /><link href="favicon.png" rel="icon" type="image/png" /></head><body class="page_classes blog blog_2015 blog_2015_01 blog_2015_01_07 blog_2015_01_07_association_dependent_options"><header class="navbar navbar-static-top"><div class="container"><div class="navbar-header"><button class="navbar-toggle collapsed" data-target=".bs-navbar-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/"><img src="/images/logo.png" /></a></div><nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation"><ul class="nav navbar-nav"><li><a href="../../../../#latest-news">News</a></li><li><a href="https://github.com/neo4jrb/neo4j/wiki">Documentation</a></li><li><a href="../../../../#getting-started">Get started</a></li><li><a href="../../../../#getting-involved">Get involved</a></li><li><a href="../../../../#getting-help">Getting Help</a></li></ul></nav></div></header><div class="container" id="main"><div class="row"><div class="col-xs-8" id="content"><div class="panel blog-post"><div class="panel-heading"><h2>Association Dependent Options</h2></div><div class="panel-body"><p>(This is really part two of the post about transactions, but it&#39;s both long and significant enough that I thought it warranted another post. If you haven&#39;t read part 1, maybe you could <a href="/blog/2015/01/06/transactions_everywhere.html">click here</a> and check it out.)</p>

<p>We&#39;ve had a lot of requests for <code>dependent: :destroy</code> and <code>dependent: :delete</code> and now that we wrap everything in transactions, we&#39;re able to add this safely. It was merged into master a few hours ago and will be in the next RC... with a very graphy twist. Read on.</p>

<p>If you haven&#39;t used either of these before in ActiveRecord, the idea is pretty simple: add one of those options to the end of an association and when a node is destroyed, it will perform the given action on all associated records. If I call <code>post.destroy</code> and that Post has many Comments, all of the comments will also be deleted in Cypher or destroyed in Ruby, depending on the option given.</p>

<p>So... what&#39;s the graphy twist? Something I describe as <code>dependent: :delete_orphans</code> and <code>dependent: :destroy_orphans</code>. Aside from being two of the most <a href="/images/immortal.png">metal</a> options in the gem, they let you do something that could be very expensive in SQL: delete or destroy only those related nodes that will be &quot;orphaned&quot; -- have no other relationships of the same type -- when a node is destroyed.</p>

<p>Imagine you have an app that models live events. You have models for Tour, Route, Stop. A tour can have multiple routes, a route can only have one tour and any number of stops, a stop can be associated with multiple routes but must have at least one. You could model the <code>:stops</code> association like this:</p>

<pre><code class="ruby">class Route
  include Neo4j::ActiveNode
  has_many :out, :stops, type: &#39;STOPPING_AT&#39;, dependent: :delete_orphans
end
</code></pre>

<p>Now, when you call <code>route.destroy</code>, it will write a Cypher query to match and delete <em>only</em> those Stops that have no other routes associated with them. In SQL, this could be an extremely complicated, expensive query; in Neo4j... not so much. It&#39;s actually very easy to write in Cypher:</p>

<pre><code>MATCH (route:Route {id: {route_id} })
WITH route
OPTIONAL MATCH (route)-[r:STOPPING_AT]-&gt;(s)
WHERE NOT EXISTS((route)--(s)&lt;-[:STOPPING_AT]-())
DELETE r,s
</code></pre>

<p>Of course, performance will greatly depend on how many associated nodes you have, but our tests indicate great performance. Benchmarks to come. As with ActiveRecord, be aware that both <code>:destroy</code> options will return each matched node to Ruby and call <code>destroy</code> one by one, so you may take a big performance hit if there are a high number of related objects.</p>

<p>That&#39;s pretty much it. This is a new feature so if you&#39;re going to dive in on the master branch, please be sure to get in touch if you run into any bugs or have any feedback. Until then, enjoy!</p>
</div><small>Posted 2015/01/07 by Chris Grigg<br />Tagged with <a href="/blog/tags/changelog.html">changelog</a></small></div></div><div class="col-sm-1"></div><div class="col-sm-3" id="sidebar"><div class="panel"><div class="panel-body"><p class="git-stats build-info"></p><p class="latest-release build-info"></p><p class="git-star build-info"><iframe allowtransparency="true" frameborder="0" height="20" scrolling="0" src="http://ghbtns.com/github-btn.html?user=neo4jrb&repo=neo4j&type=watch&count=true&size=small" width="110"></iframe></p><p><a href="https://travis-ci.org/neo4jrb/neo4j"><img src="https://travis-ci.org/neo4jrb/neo4j.svg?branch=master" /></a></p><p><a href="https://coveralls.io/r/neo4jrb/neo4j?branch=master"><img src="https://coveralls.io/repos/neo4jrb/neo4j/badge.png?branch=master" /></a></p><a href="https://codeclimate.com/github/neo4jrb/neo4j"><img src="https://codeclimate.com/github/neo4jrb/neo4j/badges/gpa.svg" /></a></div></div><div class="panel"><div class="panel-header"><h3>Primary maintainers</h3></div><div class="panel-body"><div class="maintainer"><h4>Chris Grigg</h4><div class="media"><div class="media-left"><img src="https://avatars.githubusercontent.com/subvertallchris" /></div><div class="media-body"><div><i class="fa fa-external-link"></i> <a href="http://blog.subvertallmedia.com/">Blog</a></div><div><i class="fa fa-github"></i> <a href="https://github.com/subvertallchris/">subvertallchris</a></div><div><i class="fa fa-twitter"></i> <a href="https://twitter.com/subvertallmedia">subvertallmedia</a></div></div></div></div><div class="maintainer"><h4>Brian Underwood</h4><div class="media"><div class="media-left"><img src="https://avatars.githubusercontent.com/cheerfulstoic" /></div><div class="media-body"><div><i class="fa fa-external-link"></i> <a href="http://blog.brian-underwood.codes/">Blog</a></div><div><i class="fa fa-github"></i> <a href="https://github.com/cheerfulstoic/">cheerfulstoic</a></div><div><i class="fa fa-twitter"></i> <a href="https://twitter.com/cheerfulstoic">cheerfulstoic</a></div></div></div></div></div><div class="panel-header"><h3>Original Creator</h3></div><div class="panel-body"><div class="maintainer"><h4>Andreas Ronge</h4><div class="media"><div class="media-left"><img src="https://avatars.githubusercontent.com/andreasronge" /></div><div class="media-body"><div><i class="fa fa-external-link"></i> <a href="http://www.jayway.com/author/andreasronge/">Blog</a></div><div><i class="fa fa-github"></i> <a href="https://github.com/andreasronge">andreasronge</a></div><div><i class="fa fa-twitter"></i> <a href="https://twitter.com/ronge">ronge</a></div></div></div></div></div></div><div class="panel"><div class="panel-body"><script data-gratipay-username="cheerfulstoic" src="//grtp.co/v1.js"></script></div></div></div></div></div><a href="https://github.com/neo4jrb/neo4j" id="github"><img alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" style="position: absolute; top: 0; right: 0; border: 0;" /></a><script src="/javascripts/all.js" type="text/javascript"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-57970757-1', 'auto');
ga('send', 'pageview');</script></body></html>